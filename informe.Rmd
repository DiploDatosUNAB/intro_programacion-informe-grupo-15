---
title: "Trabajo Práctico 1"
author: "Ankudowicz Santiago y Ferrero Kevin"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
```


## Introducción
Los datos corresponden a reseñas de vinos publicadas en la revista Wine Enthusiast. 

Los datos originales fueron extraídos de [Kaggle](https://www.kaggle.com/zynicide/wine-reviews), que los obtuvo desde Wine Enthusiast  la semana del 15 de junio de 2017. Luego fueron traducidos. En este informe estamos utilizando un archivo csv tal como fue provisto por el docente de la materia. 

## Exploración de los datos


```{r}
# Código para cargar o leer los datos
vinos <- read.csv("datos/vinos.csv")
```

¿Qué variables tiene? Tiene 10 variables. 
Puedo averiguar esto utilizando str() o ls()

```{r}
# Uso la función str() para obtener una descripción sintética del data.frame "vinos"
str(vinos)
```

```{r}
# Uso ls() para listar los objetos (vectores) incluidos en "vinos"
ls(vinos)
```
¿Cuántas observaciones hay? Hay 129.971 observaciones
Este resultado también se obtiene de los resultados de str().
Alternativamente, se puede utilizar la función nrow()

```{r}
nrow(vinos)
```
¿Cuántas variables? Como ya dijimos, hay un total de 10 variables. 

## Análisis de variables seleccionadas 

Para lo anterior podemos utilizar la función summarise() y obtener algunos estádisticos para las variables numéricas: mínimo, máximo, promedio y desvìo estándar.

Cambiamos la estructura de datos para abreviar el código. Utilizamos la función pivot_longer para "alargar"  


```{r}
vinos |>
  select(precio, puntos) |> 
  pivot_longer(cols = 1:2, names_to = "variable", values_to = "valor") |> 
  group_by(variable) |> 
  summarise(promedio = mean(valor, na.rm = TRUE), 
            sd = sd(valor, na.rm = TRUE),
            min = min(valor, na.rm = TRUE),
            max = max(valor, na.rm = TRUE))
```


- ¿Hay alguna anomalía que sugiera que hay datos incorrectos? Valores imposibles (como valores negativos en una variable que sólo puede ser positiva) o poco creíbles.

No se observan valores atípicos para las variables precio y puntos. 
Específicamente para la variable precio, hay algunos valores muy por encima del resto, pero no parece tratarse de un error. De todas maneras, se podría recalcular el promedio excluyendo los valores extremos para evaluar su impacto sobre el precio promedio.

```{r}
vinos|>
  summarise(precio_promedio = mean(precio, trim = 0.001, na.rm = TRUE))
```
Como se observa el impacto de esta exclusión no es muy significativo.

Además, podemos graficar la cantidad de vinos reseñados para cada rango de precios utilizando un histograma.


```{r}
vinos |> 
  ggplot(aes(precio)) + 
  geom_histogram(binwidth = 15)
```


Esto nos confirma que son pocos los vinos con precios muy elevados. 

- ¿Cuántas observaciones hay por cada grupo? ¿Cuántos valores faltantes? ¿Hay diferencias?

Para responder estas preguntas empezamos agrupando por país, detallando la cantidad de reseñas para cada uno y las presentamos en orden descendente 

```{r}
vinos |>
  group_by(pais) |>
  summarise(cantidad_resenas= n()) |>
  arrange(desc(cantidad_resenas))
```
Para saber cuantos valores faltantes hay por cada variable y en cada grupo, podemos hacer lo siguiente (almacenamos los resultados en un nuevo data.frame para utilizarlo luego con mayor facilidad)

```{r}
vinos_pais_nas <- vinos %>%
  group_by(pais) %>% 
  summarise(cantidad_reseñas = n(), 
            pais_nas = sum(is.na(pais)), 
            nombre_nas = sum(is.na(nombre)), 
            puntos_nas = sum(is.na(puntos)), 
            precio_nas = sum(is.na(precio)), 
            provincia_nas = sum(is.na(provincia)), 
            region_1_nas = sum(is.na(region_1)), 
            region_2_nas = sum(is.na(region_2)), 
            variedad_nas = sum(is.na(variedad)), 
            vina_nas = sum(is.na(vina)), 
            titulo_resena_nas = sum(is.na(titulo_resena))) %>%
  arrange(desc(cantidad_reseñas))
```

Esto nos permite conocer la cantidad de valores faltantes de cada grupo para cada variable. 
Para evaluar si existen diferencias entre grupos resulta más conveniente ver la proporcion de valores faltantes en el total de reseñas, a continuación se presenta este procedimiento para la variable nombre a modo de ejemplo

```{r}
vinos_pais_nas <- vinos_pais_nas |>
  mutate(proporción_nombre_nas = nombre_nas/cantidad_reseñas)
```


```{r}
vinos_pais_nas |>
  select(pais, proporción_nombre_nas, cantidad_reseñas) |>
  ggplot(aes(proporción_nombre_nas, pais)) +
  geom_col() 
#revisar las etiquetas que se superponen al mostrar el eje
```


La cantidad de nombres faltantes difiere entre paises. Este análisis podría replicarse para otras variables. 

## Hipótesis

1- Los vinos de mayor precio reciben mayor puntaje.

Para obtener una primera aproximación a la validez de esta hipótesis, graficamos ambas variables

```{r}
vinos |> 
  ggplot(aes( x = precio, y = puntos))+
  geom_count()
```

El gráfico no es muy concluyente. Calculamos el puntaje promedio que se obtiene para cada precio y graficamos los resultados

```{r}
vinos |> 
  group_by(precio) |> 
  summarise(puntaje_prom = mean(puntos)) |> 
  ggplot(aes(x = precio, y = puntaje_prom))+
  geom_point()
```

Para los vinos de menor precio se observa claramente que el puntaje promedio crece a la par que el precio se incrementa. Sin embargo, esa relación no se mantiene para todo el rango de precios, al menos no de forma inequívoca. 

Recordando que la gran mayoría de los vinos se encuentran en un rango de precios bajo, podemos analizar la validez de la hipótesis separando las observaciones en dos conjuntos. Cómo parámetro para dividirlas utilizaremos el precio promedio más dos desvíos estándar de esta misma variable

# #AUTOMATIZAR EL 117.4 USADO ABAJO

```{r}
vinos |> 
  filter(precio <= 117.4) |> 
  group_by(precio) |> 
  summarise(puntaje_prom = mean(puntos)) |> 
  ggplot(aes(x = precio, y = puntaje_prom))+
  geom_point()
```


```{r}
vinos |> 
  filter( precio >= 117.4) |> 
  group_by(precio) |> 
  summarise(puntaje_prom = mean(puntos)) |> 
  ggplot(aes(x = precio, y = puntaje_prom))+
  geom_point()
```

Estos últimos gráficos, permiten confirmar que nuestra hipótesis es compatible con vinos de precios bajos, pierde validez a medida que el precio crece y directamente no parece compatible con vinos de precios altos (por ejemplo mayores a 500 o 1000). 

Por último realizamos una regresión lineal para profundizar la evaluación 

```{r}
  summary(lm(vinos$precio ~ vinos$puntos))
```
El r cuadrado obtenido es muy bajo. Esto se debe a una gran variabilidad en el puntaje otorgado a vinos del mismo precio o precios similares. 

En definitiva, si bien se observa que en el puntaje promedio crece a medida que aumenta el precio de los vinos, la variabilidad es muy alta como para establecer una asociación sencilla entre ambas variables.

2- Para cada provincia/region las variedades reseñadas se concentran fuertemente en una variedad particular de vinos.

```{r}
resenas_provincia <- vinos |> 
  group_by(provincia) |> 
  summarise(cantidad_resenas_prov = n()) |> 
  arrange(desc(cantidad_resenas_prov))
```

```{r}
concentracion_provincia <- vinos |> 
  group_by(provincia,variedad) |> 
  summarise(cantidad_resenas_prov_var = n(), ) |> 
  arrange(desc(cantidad_resenas_prov_var)) |> 
  left_join(resenas_provincia, by = "provincia") |> 
  mutate(proporcion = cantidad_resenas_prov_var / cantidad_resenas_prov) |> 
  select(provincia, variedad, proporcion, cantidad_resenas_prov_var, cantidad_resenas_prov) |>
  slice_max(proporcion, with_ties = FALSE) |> 
  arrange(desc(cantidad_resenas_prov))
```
```{r}
concentracion_provincia |> 
  filter(proporcion >= 0.5) 
```

Más de la mitad de las provincias (229 de 426) tienen una concrentración de al menos un 50% de sus reseñas explicadas por la principal variedad reseñada.

## COMPLETAR GRÁFICO CON CASOS ACUMULADOS O ELIMINAR

```{r}
concentracion_provincia |> 
  head(30) |> 
  ggplot(aes(x = proporcion, y = provincia))+
  geom_col()
```

```{r}
concentracion_provincia |> 
  ggplot(aes(proporcion))+
  geom_histogram()

```


3- Para las variedades de vinos más reseñadas, el precio difiere significativamente según se trate de vinos provenientes del hemisferio norte o del hemisferio sur.

```{r}
vinos |> 
  group_by(variedad) |> 
  summarise(cantidad_reseñas = n()) |> 
  arrange(desc(cantidad_reseñas))
```


Identificar variedades de vinos reseñadas más reseñadas y que tengan producción en ambos hemisferios y ver con cuales nos quedamos. Validar la hipótesis. 

listado de países y definimos manualmente el hemisferio al que pertenecen
```{r}
pais_hemisferio <- vinos |> 
  distinct(pais) |>
  arrange(pais) |> 
  mutate(hemisferio = c("N","S","N","S","N","N","S","N","N","S","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","S","S","N","N","N","N","S","N","N","N","S",NA))
```

```{r}
vinos_hemisferio <- vinos |> 
  left_join(pais_hemisferio, by = "pais")
```

```{r}
vinos_hemisferio |> 
  filter(hemisferio == "N" | hemisferio == "S") |> 
  group_by(variedad,hemisferio) |> 
  summarise(cantidad_reseñas = n()) |> 
  pivot_wider(names_from = hemisferio,values_from = cantidad_reseñas) |> 
  mutate(total = N+S) |> 
  arrange(desc(total))
```

Quedan 702 variedades porque hay 6 de ellas para las cuáles ninguna de sus reseñas indica el país de origen. No pueden ser consideradas para esta hipótesis. 

Nos quedamos con las 10 principales variedades, todas ellas tienen producción en los hemisferios norte y sur. 

```{r}
variedades_mas_resenadas <- vinos_hemisferio |> 
  filter(hemisferio == "N" | hemisferio == "S") |> 
  group_by(variedad,hemisferio) |> 
  summarise(cantidad_reseñas = n()) |> 
  pivot_wider(names_from = hemisferio,values_from = cantidad_reseñas) |> 
  mutate(total = N+S) |> 
  arrange(desc(total)) |> 
  head(10) |> 
  select(variedad)
```
```{r}
vinos_hemisferio |> 
  filter(hemisferio =="N" | hemisferio =="S") |> 
  semi_join(variedades_mas_resenadas, by = "variedad") |> 
  group_by(variedad,hemisferio) |> 
  summarise(precio_prom = mean(precio, na.rm = TRUE)) |> 
  pivot_wider(names_from = hemisferio, values_from = precio_prom) |> 
  mutate(ratio = N/S)
```

Se observan diferencias significativas en el precio promedio de cada variedad según el hemisferio de dónde provengan. En general, el precio del hemisferio norte es más caro, en algunos casos más que duplicando el precio del hemisferio sur. 
